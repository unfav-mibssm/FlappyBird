<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird - Precision Edition</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; }
        #game-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            background: #70c5ce; 
            overflow: hidden;
        }
        #bird {
            position: absolute;
            width: 44px; /* Reduced visual size slightly for better feel */
            height: 30px;
            left: 50px;
            top: 50%;
            background-image: url('https://i.postimg.cc/05HgJxfZ/yellowbird-midflap.png');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 10;
        }
        .pipe {
            position: absolute;
            width: 60px;
            background: #73bf2e;
            border: 3px solid #543847; /* Darker border to see the edges clearly */
            right: -70px;
            box-sizing: border-box;
        }
        #score {
            position: absolute;
            top: 10%;
            width: 100%;
            text-align: center;
            font-size: 60px;
            color: white;
            text-shadow: 3px 3px 0 #000;
            z-index: 20;
            user-select: none;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 28px;
            text-shadow: 2px 2px 0 #000;
            z-index: 30;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="score">0</div>
    <div id="message">TAP TO START</div>
    <div id="bird"></div>
</div>

<script>
    const bird = document.getElementById('bird');
    const container = document.getElementById('game-container');
    const scoreElement = document.getElementById('score');
    const message = document.getElementById('message');

    // Configuration
    let birdY = window.innerHeight / 2;
    let velocity = 0;
    let gravity = 0.3;
    let jumpForce = -7;
    let gap = 180; // Slightly wider gap for fairness
    let score = 0;
    let isGameOver = true;
    let pipes = [];
    let animationId;

    function startGame() {
        isGameOver = false;
        score = 0;
        birdY = window.innerHeight / 2;
        velocity = 0;
        pipes.forEach(p => {
            p.topPipe.remove();
            p.bottomPipe.remove();
        });
        pipes = [];
        scoreElement.innerText = '0';
        message.style.display = 'none';
        gameLoop();
    }

    function gameLoop() {
        if (isGameOver) return;

        // Physics
        velocity += gravity;
        birdY += velocity;
        bird.style.top = birdY + 'px';

        // Bird Tilt
        let rotation = Math.min(Math.max(velocity * 3, -20), 90);
        bird.style.transform = `rotate(${rotation}deg)`;

        // Check if hit ceiling or floor
        if (birdY < 0 || birdY + 30 > window.innerHeight) {
            endGame();
        }

        // Spawn Pipes
        if (pipes.length === 0 || pipes[pipes.length - 1].x < window.innerWidth - 280) {
            createPipe();
        }

        // Move and Check Pipes
        pipes.forEach((p, index) => {
            p.x -= 3.5; // Pipe Speed
            p.topPipe.style.left = p.x + 'px';
            p.bottomPipe.style.left = p.x + 'px';

            // Collision Check (The Fixed Part)
            if (checkCollision(p)) {
                endGame();
            }

            // Score Logic
            if (!p.passed && p.x + 60 < 50) {
                p.passed = true;
                score++;
                scoreElement.innerText = score;
            }

            // Cleanup
            if (p.x < -100) {
                p.topPipe.remove();
                p.bottomPipe.remove();
                pipes.splice(index, 1);
            }
        });

        animationId = requestAnimationFrame(gameLoop);
    }

    function createPipe() {
        const minHeight = 100;
        const range = window.innerHeight - gap - (minHeight * 2);
        const topHeight = Math.floor(Math.random() * range) + minHeight;
        
        const topPipe = document.createElement('div');
        topPipe.className = 'pipe';
        topPipe.style.height = topHeight + 'px';
        topPipe.style.top = '0';
        
        const bottomPipe = document.createElement('div');
        bottomPipe.className = 'pipe';
        bottomPipe.style.height = (window.innerHeight - topHeight - gap) + 'px';
        bottomPipe.style.bottom = '0';

        container.appendChild(topPipe);
        container.appendChild(bottomPipe);

        pipes.push({
            x: window.innerWidth,
            topPipe,
            bottomPipe,
            topHeight,
            passed: false
        });
    }

    function checkCollision(p) {
        // Hitbox Buffer: Bird is 44x30. 
        // We shrink the hitbox by 6px so it's more forgiving.
        const b = {
            left: 50 + 6,
            right: 50 + 44 - 6,
            top: birdY + 6,
            bottom: birdY + 30 - 6
        };

        const pBox = {
            left: p.x,
            right: p.x + 60,
            top: p.topHeight,
            bottom: p.topHeight + gap
        };

        // If bird is horizontally inside the pipe
        if (b.right > pBox.left && b.left < pBox.right) {
            // If bird is NOT inside the gap
            if (b.top < pBox.top || b.bottom > pBox.bottom) {
                return true;
            }
        }
        return false;
    }

    function endGame() {
        isGameOver = true;
        cancelAnimationFrame(animationId);
        message.style.display = 'block';
        message.innerHTML = `GAME OVER<br><small>Score: ${score}</small><br>TAP TO RESTART`;
    }

    function handleInput(e) {
        if (e.type === 'keydown' && e.code !== 'Space') return;
        
        if (isGameOver) {
            startGame();
        } else {
            velocity = jumpForce;
        }
    }

    window.addEventListener('mousedown', handleInput);
    window.addEventListener('keydown', handleInput);
    window.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Prevents double-tapping zoom on mobile
        handleInput(e);
    }, {passive: false});

</script>

</body>
</html>
